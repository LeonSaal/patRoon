Details
===

<script>
`r readAllFile(system.file("js", "utils-report-new.js", package = "patRoon"))`
</script>

<style>
/* HACK: to make expander button visible on both dark and light backgrounds */
.rt-expander:after {
    border-top-color: dodgerblue;
}
</style>

##

```{r, echo = FALSE,eval=TRUE}
# small tools to make handling optional elements easier
maybeIncl <- function(cond, tag) if (cond) tag else NULL
callIncl <- function(f, ..., fixed = NULL) do.call(f, c(pruneList(list(...)), fixed))

bslib::layout_column_wrap(
    width = 1,
    height = "100%",
    style = "padding-bottom: 10px; padding-right: 10px;",
    bslib::card(
        full_screen = TRUE,
        bslib::card_header("Feature groups"),
        bslib::card_body(
            class = "mt-2",
            htmltools::withTags({
                callIncl(div, class = "pb-1",
                    label("for" = "view-select", "View"),
                    callIncl(select, name = "view", id = "view-select", onChange = "updateView(this.value)",
                           style = list("margin-right" = "10px", "margin-top" = " 3px"),
                           option(value = "Plain", "Plain"),
                           maybeIncl(utils$hasSuspects(), option(value = "Suspects", "Suspects")),
                           maybeIncl(utils$hasComponents(), option(value = "Components", "Components")),
                           maybeIncl(utils$hasTPs(), option(value = "TPs", "Transformation products"))
                    ),
                    
                    input(type = "checkbox", id = "fg-cols-info", onChange = 'showFGCols("group", this.checked)',
                          checked = TRUE),
                    label("for" = "fg-cols-info", "Group info"),
                    input(type = "checkbox", id = "fg-cols-int", onChange = 'showFGCols("intensities", this.checked)',
                          checked = TRUE),
                    label("for" = "fg-cols-int", "Intensities"),
                    maybeIncl(utils$hasFQualities(), input(type = "checkbox", id = "fg-cols-qual",
                                                           onChange = 'showFGCols("qualities", this.checked)')),
                    maybeIncl(utils$hasFQualities(), label("for" = "fg-cols-qual", "Quality scores")),
                    input(type = "checkbox", id = "fg-large-chroms", onChange = 'showFGCols("chrom_large", this.checked)'),
                    label("for" = "fg-large-chroms", "Large chromatograms"),
                    input(type = "checkbox", id = "fg-filter", onChange = 'toggleFGFilters(this.checked)'),
                    label("for" = "fg-filter", style = list("margin-right" = "10px"), "Filters"),
                    
                    button(type = "button", class = "btn btn-primary btn-sm", onClick = "Reactable.downloadDataCSV(getSelFGTableElement())", "Download CSV"),
                    button(type = "button", class = "btn btn-primary btn-sm", id = "fg-expand",
                           onClick = "Reactable.toggleAllRowsExpanded(getSelFGTableElement())",  style = list(display = "none"), "Expand/collapse"),
                    
                    div(class = "float-right",
                        label("for" = "fg-search", "Search"),
                        input(type = "text", id = "fg-search", oninput="Reactable.setSearch(getSelFGTableElement(), this.value)")
                    )
                )
            })
        ),
        callIncl(bslib::card_body_fill,
            utils$genFGTablePlain(),
            maybeIncl(utils$hasSuspects(), utils$genFGTableSuspects()),
            maybeIncl(utils$hasComponents(), utils$genFGTableComponents()),
            maybeIncl(utils$hasTPs(), utils$genFGTableTPs())
        ),
    ),
    callIncl(bslib::layout_column_wrap,
        fixed = list(width = NULL),
        style = htmltools::css(grid_template_columns = "1fr 2fr"),
        heights_equal = "row",
        class = "bottomLayout",
        maybeIncl(utils$hasSuspects(), bslib::navs_tab_card(
            title = "Selected suspect",
            full_screen = TRUE,
            bslib::nav(
                "Suspect",
                bslib::card_body_fill(htmltools::img(id = "struct_view-suspect"))
            ),
            bslib::nav(
                "Info",
                "Info here?"
            )
        )),
        maybeIncl(utils$hasComponents(), callIncl(bslib::navs_tab_card,
            title = "Selected component",
            full_screen = TRUE,
            bslib::nav(
                "Chromatogram",
                bslib::card_body_fill(htmltools::img(id = "chrom_view-component"))
            ),
            bslib::nav(
                "Spectrum",
                bslib::card_body_fill(htmltools::img(id = "spectrum_view-component"))
            ),
            maybeIncl(utils$hasComponentsIntClust(), bslib::nav(
                "Profile",
                bslib::card_body_fill(
                    htmltools::img(id = "profileRel_view-component"),
                    htmltools::img(id = "profileAbs_view-component")
                )
            ))
        )),
        maybeIncl(utils$hasTPs(), bslib::navs_tab_card(
            title = "Selected parent",
            full_screen = TRUE,
            bslib::nav(
                "Chromatogram",
                bslib::card_body_fill(htmltools::img(id = "chrom_view-tp"))
            ),
            bslib::nav(
                "Suspect",
                bslib::card_body_fill(htmltools::img(id = "struct_view-tp"))
            ),
            bslib::nav(
                "Transformations",
                bslib::card_body_fill(utils$genTPGraphs())
            )
        )),
        callIncl(bslib::navs_tab_card,
            title = "Selected feature group",
            id = "fGroupSelTabs",
            full_screen = TRUE,
            bslib::nav(
                "Features",
                bslib::card_body(
                    class = "mt-2",
                    htmltools::withTags({
                        callIncl(div, class = "pb-1",
                            label("for" = "features-groupBy", "Group by"),
                            callIncl(select, id = "features-groupBy", onChange = "Reactable.setGroupBy('featuresTab', [ this.value ])",
                                     style = list("margin-right" = "10px", "margin-top" = " 3px"),
                                     option(value = "", "None"),
                                     option(value = "rGroup", "Replicate group"),
                                     maybeIncl(utils$hasSets(), option(value = "set", "Set"))
                            ),
                            
                            maybeIncl(utils$hasFQualities(), input(type = "checkbox", id = "features-cols-qual",
                                                                   onChange = 'showFeatQualityCols(this.checked)')),
                            maybeIncl(utils$hasFQualities(), label("for" = "features-cols-qual", "Quality scores")),
                            input(type = "checkbox", id = "features-filter", onChange = 'toggleFeatFilters(this.checked)'),
                            label("for" = "features-filter", style = list("margin-right" = "10px"), "Filters"),
                            
                            button(type = "button", class = "btn btn-primary btn-sm", onClick = "Reactable.downloadDataCSV('featuresTab')", "Download CSV"),
                            button(type = "button", class = "btn btn-primary btn-sm", id = "feat-expand",
                                   onClick = "Reactable.toggleAllRowsExpanded('featuresTab')", "Expand/collapse")
                        )
                    })
                ),
                bslib::card_body_fill(utils$genFeaturesTable())
            ),
            maybeIncl(utils$hasFormulas(), bslib::nav(
                "Formulas",
                bslib::card_body(
                    class = "mt-2",
                    htmltools::withTags({
                        div(class = "pb-1",
                            input(type = "checkbox", id = "formulas-filter", onChange = 'toggleFormFilters(this.checked)'),
                            label("for" = "formulas-filter", style = list("margin-right" = "10px"), "Filters"),
                            button(type = "button", class = "btn btn-primary btn-sm",
                                   onClick = "Reactable.downloadDataCSV('formulasTab')", "Download CSV"),
                        )
                    })
                ),
                bslib::card_body_fill(utils$genFormulasTable())
            )),
            maybeIncl(utils$hasCompounds(), bslib::nav(
                "Compounds",
                bslib::card_body(
                    class = "mt-2",
                    htmltools::withTags({
                        div(class = "pb-1",
                            label("for" = "compounds-groupBy", "Group by"),
                            select(id = "compounds-groupBy", onChange = "Reactable.setGroupBy('compoundsTab', [ this.value ])",
                                   style = list("margin-right" = "10px", "margin-top" = " 3px"),
                                   option(value = "", "None"),
                                   option(value = "neutral_formula", "Formula")
                            ),
                            
                            input(type = "checkbox", id = "compounds-filter", onChange = 'toggleCompFilters(this.checked)'),
                            label("for" = "compounds-filter", style = list("margin-right" = "10px"), "Filters"),
                            
                            button(type = "button", class = "btn btn-primary btn-sm", onClick = "Reactable.downloadDataCSV('compoundsTab')", "Download CSV"),
                            button(type = "button", class = "btn btn-primary btn-sm", id = "comp-expand",
                                   onClick = "Reactable.toggleAllRowsExpanded('compoundsTab')", "Expand/collapse")
                        )
                    })
                ),
                bslib::card_body_fill(utils$genCompoundsTable())
            )),
            maybeIncl(utils$hasCompsCluster(), bslib::nav(
                "Compounds clusters",
                bslib::card_body_fill(
                    htmltools::img(id = "comps_cluster-dendro"),
                    utils$genCompClustsImgs()
                )
            )),
            maybeIncl(utils$hasTPs(), bslib::nav(
                "Parent similarity",
                bslib::card_body_fill(
                    htmltools::div(
                        style = "display: flex; overflow-y: auto; align-items: center; justify-content: space-between;",
                        class = "my-3",
                        # hide img if image is unavailable: https://stackoverflow.com/a/22051972
                        htmltools::img(id = "similarity_spec", style = "flex-grow: 2; display: none;",
                                       onerror = "this.style.display='none'"),
                        htmltools::div(style = "flex-grow: 1; overflow-y: auto;",
                                       utils$genTPSimTable())
                    )
                )
            ))
        )
    )
)
```
