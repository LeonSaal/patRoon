<script>`r readAllFile(system.file("js", "utils-report.js", package = "patRoon"))`</script>

Transformation Products {data-orientation=rows}
===

```{r TPPlots, fig.keep='none'}
components <- rmdVars$components[, names(rmdVars$fGroups)]
cInfo <- componentInfo(components)

plotPathFull <- getPlotPath(FALSE)

message("Generating precursor plots...")
prog <- openProgBar(0, nrow(cInfo))

makeStructPlot <- function(SMI, out)
{
    mol <- getMoleculesFromSMILES(SMI, emptyIfFails = TRUE)[[1]]
    withr::with_png(out, width = 1.5, height = 1.5, units = "in", res = 72, bg = NA, code = {
        withr::with_par(list(mar = rep(0, 4)), plot(getRCDKStructurePlot(mol, 150, 150)))
    })
}

precPlots <- setNames(Map(split(cInfo, seq_len(nrow(cInfo))), seq_len(nrow(cInfo)), f = function(precRow, i)
{
    grpi <- match(precRow$precursor_group, names(rmdVars$fGroups))
    plots <- list()
    fg <- rmdVars$fGroups[, precRow$precursor_group]
    
    plots[["int"]] <- file.path(plotPathFull, sprintf("int-prec_%d.png", grpi))
    makeCachedPlot(plots[["int"]], "plotInt", list(fg, average = TRUE), 3.3, 3.3, bg = NA, cacheDB = rmdVars$cacheDB)

    if (!is.null(precRow[["precursor_SMILES"]]))
    {
        plots[["struct"]] <- file.path(plotPathFull, sprintf("struct-prec_%d.png", grpi))
        makeStructPlot(precRow$precursor_SMILES, plots[["struct"]])
    }

    setTxtProgressBar(prog, i)
    
    return(plots)
}), cInfo$name)

message("Generating TP plots...")
prog <- openProgBar(0, length(components))
cmpTab <- as.data.table(components)
# isFGScrAnnotated <- isScreening(rmdVars$fGroups) && screenInfo(rmdVars$fGroups)[[""]]

TPPlotName <- function(cmp, grp) paste0(cmp, "_", grp)

TPPlots <- setNames(Map(split(cmpTab, seq_len(nrow(cmpTab))), seq_len(nrow(cmpTab)), f = function(ctRow, i)
{
    grpi <- match(ctRow$group, names(rmdVars$fGroups))
    plots <- list()
    fg <- rmdVars$fGroups[, ctRow$group]
    
    plots[["int"]] <- file.path(plotPathFull, sprintf("int-TP_%d.png", grpi))
    makeCachedPlot(plots[["int"]], "plotInt", list(fg, average = TRUE), 3.3, 3.3, bg = NA, cacheDB = rmdVars$cacheDB)

    SMI <- ctRow$precursor_SMILES # ctRow[["SMILES"]] UNDONE
    if (!is.null(SMI))
    {
        plots[["struct"]] <- file.path(plotPathFull, sprintf("struct-prec_%d.png", grpi))
        makeStructPlot(SMI, plots[["struct"]])
    }
    
    plSpecArgs <- list()
    
    # UNDONE: handle compounds/formulas somehow. Needs non set specific ranks
    # if (!is.null(fgTab) && !is.null(rmdVars$compounds) && all(c(ctRow$precursor_group, ctRow$group) %chin% names(rmdVars$compounds)))
    # {
    #     plSpecArgs <- list(rmdVars$compounds, compi,  grp, rmdVars$MSPeakLists,
    #                        rmdVars$formulas, FALSE)
    #     makeCachedPlot(ret, "plotSpectrum", list(rmdVars$compounds, compi,  grp, rmdVars$MSPeakLists,
    #                                              rmdVars$formulas, FALSE),
    #                    7, 4.5, bg = NA, cacheDB = rmdVars$cacheDB)
    # }
    if (!is.null(rmdVars[["MSPeakLists"]]) && !is.null(rmdVars$MSPeakLists[[ctRow$precursor_group]][["MSMS"]]) &&
        !is.null(rmdVars$MSPeakLists[[ctRow$group]][["MSMS"]]))
    {
        plots[["spec"]] <- file.path(plotPathFull, sprintf("spec-sim_%d.png", grpi))
        # UNDONE: specSimParams in rmdVars
        makeCachedPlot(plots[["spec"]], "plotSpectrum", list(rmdVars$MSPeakLists, groupName = c(ctRow$precursor_group, ctRow$group),
                                                             MSLevel = 2, specSimParams = getDefSpecSimParams(), title = ""),
                       5, 4.5, bg = NA, cacheDB = rmdVars$cacheDB)
    }

    setTxtProgressBar(prog, i)
    
    return(plots)
}), TPPlotName(cmpTab$name, cmpTab$group))

prepPlots <- function(pl)
{
    ap <- unlist(allPlots); ap <- ap[nzchar(ap)]
    if (rmdVars$optimizePng && length(ap > 0))
        optimizePngPlots(ap)
    
    if (rmdVars$selfContained)
        pl <- rapply(pl, function(ap) sapply(ap, function(p) if (nzchar(p)) knitr::image_uri(p) else ""), how = "replace")
    return(pl)
}

precPlots <- prepPlots(precPlots); TPPlots <- prepPlots(TPPlots)
```


##
    
### Precursors { data-width=400 .precursors }
    
<style> .precursors { overflow-x: auto; } </style>
    
```{r echo=FALSE}
makeTPTab <- function(cr, cols)
{
    allCols <- unique(unlist(lapply(cols, function(cl) grep(paste0("^", cl), names(cr), value = TRUE))))
    
    if (!isTRUE(all.equal(cols, allCols, check.attributes = FALSE)))
    {
        sets <- unique(sub(".+\\-(.+)$", "\\1", allCols[grepl("-", allCols, fixed = TRUE)]))
        
        ret <- rbindlist(lapply(c("", sets), function(s)
        {
            takeCols <- if (!nzchar(s)) cols else paste0(cols, "-", s)
            whCols <- which(takeCols %in% names(cr))
            if (length(whCols) == 0)
                return(data.table())
            
            t <- cr[, takeCols, with = FALSE]
            setnames(t, cols[whCols])
            
            t[, (names(t)) := lapply(.SD, function(x) if (is.double(x)) round(x, 2) else x)]
            
            t[, set := s]
            setcolorder(t, "set")
            
            return(t)
        }))
    }
    else
        ret <- cr[, cols, with = FALSE]
    
    return(knitr::kable(ret, "html", escape = FALSE) %>%
               kableExtra::kable_styling(font_size = 11) %>%
               kableExtra::scroll_box(extra_css = "overflow-x: auto;"))

}

chromPlotStyle <- "width: auto; height: 250px;"

if (isScreening(rmdVars$fGroups))
{
    suspTbl <- as.data.table(rmdVars$fGroups, collapseSuspects = NULL)
    suspTbl <- suspTbl[, grepl("^susp_|group", names(suspTbl)), with = FALSE]
    setnames(suspTbl, sub("^susp_", "", names(suspTbl)))
}

precDT <- data.table(compInd = seq_len(nrow(cInfo)))

precDT[, precursor := sapply(split(cInfo, seq_len(nrow(cInfo))), function(cir)
{
    precInfo <- cir[, c("name", "precursor_name", "precursor_group"), with = FALSE]
    setnames(precInfo, c("component", "name", "group"))
    
    prec <- makeInfoBox(paste0(names(precInfo), ": ", precInfo, collapse = "<br>"))
    
    if (!is.null(precPlots[[cir$name]][["struct"]]))
        prec <- paste0(imgTags(precPlots[[cir$name]][["struct"]]), "<br>", prec)
    
    return(prec)
})]

precDT[, EIC := imgTags(chromPaths[match(cInfo$precursor_group, names(rmdVars$fGroups))], style = chromPlotStyle)]

if (isScreening(rmdVars$fGroups))
{
    suspCols <- c("formRank", "compRank", "annSimBoth", "estIDLevel")
    if (any(sapply(suspCols, grepl, names(suspTbl))))
    {
        precDT[, screening := sapply(split(suspTbl[match(cInfo$precursor_group, group)], seq_len(nrow(precDT))), function(sr)
        {
            makeTPTab(sr, suspCols)
        })]
    }
}

precDT[, "intensity profile" := imgTags(sapply(precPlots[cInfo$name], "[[", "int"))]

precDT[, show := { sprintf("<button onclick=\"showTPs('%s', %d);\" style=\"padding: 0px 3px 0px 3px\">Show</button>",
                           compInd, match(cInfo$precursor_group, names(rmdVars$fGroups))) }]
setcolorder(precDT, c("compInd", "show"))

DT::datatable(precDT,
              extensions = "Buttons",
              options = list(paging = FALSE, pageLength = -1, scrollX = TRUE, scrollY = "300px",
                             dom = "tip",
                             initComplete = DT::JS("function(settings, json)",
                                                   "{ setTimeout(initTPs, 25); }"),
                             order = list(list(0, "asc")),
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = "dt-center",
                                                    targets = (seq_len(ncol(precDT)))-1))),
              escape = FALSE, rownames = FALSE, elementId = "precursorsTable")
```


##

### Transformation Products { .TPsClass }

<style> .TPsClass { overflow-x: auto; } </style>
    
```{r echo=FALSE}

cTable <- componentTable(components)

TPsDT <- rbindlist(Map(cTable, seq_along(cTable), names(cTable), f = function(cmp, cInd, cName)
{
    ret <- data.table(compInd = cInd, "#" = seq_len(nrow(cmp)))
    
    splitCmp <- split(cmp, seq_len(nrow(cmp)))
    
    trCols <- intersect(c("RTDir", "retDiff", "mzDiff", "formulaDiff"), names(cmp))
    ret[, TP := sapply(splitCmp, function(cr)
    {
        tpInfo <- cr[, c("TP_name", "group", trCols), with = FALSE]
        if (rmdVars$retMin)
            tpInfo[, retDiff := retDiff / 60]
        tpInfo[, c("retDiff", "mzDiff") := .(round(retDiff, 2), round(mzDiff, 5))]
        setnames(tpInfo, "TP_name", "name")
        
        tp <- makeInfoBox(paste0(names(tpInfo), ": ", tpInfo, collapse = "<br>"))
        
        if (!is.null(TPPlots[[TPPlotName(cName, cr$group)]][["struct"]]))
            tp <- paste0(imgTags(TPPlots[[TPPlotName(cName, cr$group)]][["struct"]]), "<br>", tp)
        
        return(tp)
    })]
    
    ret[, EIC := imgTags(chromPaths[match(cmp$group, names(rmdVars$fGroups))], style = chromPlotStyle)]
    
    if (isScreening(rmdVars$fGroups))
    {
        suspCols <- c("formRank", "compRank", "annSimBoth", "estIDLevel")
        if (any(sapply(suspCols, grepl, names(suspTbl))))
        {
            ret[, screening := sapply(split(suspTbl[match(cmp$group, group)], by = "group"), FUN = function(sr)
            {
                makeTPTab(sr, suspCols)
            })]
        }
    }
    
    specSimCols <- grep("^specSimilarity", names(cmp), value = TRUE)
    if (any(grepl("^specSimilarity", names(cmp))))
    {
        ret[, similarity := sapply(splitCmp, function(cr)
        {
            simt <- makeTPTab(cr, c("specSimilarity", "specSimilarityPrec", "specSimilarityBoth"))
            return(simt)
        })]
    }
    
    ret[, spectrum := sapply(splitCmp, function(cr)
    {
        if (!is.null(TPPlots[[TPPlotName(cName, cr$group)]][["spec"]]))
            return(paste0(imgTags(TPPlots[[TPPlotName(cName, cr$group)]][["spec"]])))
        return("")
    })]
    if (!any(nzchar(ret$spectrum)))
        set(ret, j = "spectrum", value = NULL)

    ret[, "intensity profile" := imgTags(sapply(TPPlots[TPPlotName(cName, cmp$group)], "[[", "int"))]
    return(ret)
}))

DT::datatable(TPsDT, options = list(scrollX = TRUE, scrollY = "400px", deferRender = TRUE,
                                    dom = "Blrtp", pageLength = 25, autoWidth = TRUE,
                                    ordering = FALSE,
                                    columnDefs = list(list(visible = FALSE, targets = 0),
                                                      list(className = "dt-center",
                                                           targets = (seq_len(ncol(TPsDT)))-1)),
                                    buttons = list(list(extend = "colvis", background = FALSE,
                                                        columns = seq(3, ncol(TPsDT)-1)))),
              rownames = FALSE, escape = FALSE, elementId = "TPsTable")
```

