name: btd
on:
    workflow_dispatch:
        inputs:
            makeBundle:
                type: boolean
                description: Make bundle (needed for tests)
                default: true
            doTests:
                type: boolean
                description: Perform tests
                default: true
    push
jobs:
    build-test-matrix: # based on https://stackoverflow.com/a/75337311
        strategy:
            fail-fast: true
            matrix:
                R: [ 'release', 'oldrel' ]
        name: Build ${{ matrix.R }}
        uses: ./.github/workflows/do_bt.yml
        with:
            R: ${{ matrix.R }}
            makeBundle: ${{ inputs.makeBundle && matrix.R == 'release' }}
            doTests: ${{ inputs.doTests }}
        secrets: inherit
    commit:
        needs: build-test-matrix
        runs-on: windows-latest
        name: Update patRoonDeps
        if: github.ref == 'refs/heads/master'
        steps:
            - uses: actions/checkout@v3
              with:
                  repository: rickhelmus/patRoonDeps
                  token: ${{ secrets.PAT }}
            - name: Get patch for release
              uses: actions/download-artifact@v3
              with:
                  name: patch-release
            - name: Get patch for oldrel
              uses: actions/download-artifact@v3
              with:
                  name: patch-oldrel
            - name: Apply patches
              run: |
                  git apply patRoonDeps-release.diff
                  git apply patRoonDeps-oldrel.diff
            - name: Push changes
              env: 
                  CI_COMMIT_MESSAGE: Automated GHA update
                  CI_COMMIT_AUTHOR: GHA
              run: |
                  git config --global user.name "${{ env.CI_COMMIT_AUTHOR }}"
                  git config --global user.email "notvalid@someemail.com"
                  git add bin/
                  git add patRoonDeps*.tsv
                  git status
                  git commit -m "${{ env.CI_COMMIT_MESSAGE }}"
                  git push
    release:
        needs: build-test-matrix
        runs-on: windows-latest
        name: Make bundle pre-release
        if:  ${{ inputs.makeBundle }} && github.ref == 'refs/heads/master'
        steps:
            - name: Get bundle
              uses: actions/download-artifact@v3
              with:
                  name: bundle
            - name: Make pre-release
              if: ${{ false }}
              uses: andelf/nightly-release@main
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: prerelease
                  name: 'Automated Pre-release $$'
                  prerelease: true
                  body: 'This is an automated pre-release of the patRoon bundle. See the installation handbook for details.'
                  files: |
                        patRoon-bundle-*.zip
